<?php

namespace App\Service;

/**
 * Služba pro renderování SVG ikon dopravy
 * Převedeno z WP-src/portal/shared/textIconReplacer.tsx
 */
class TransportIconService {

	/**
	 * Autobus/MHD ikona
	 */
	private function getBusIcon( int $size ): string {
		$width = round( $size * 1.7 );

		return '<svg width="' . $width . '" height="' . $size . '" viewBox="0 0 30 16" xmlns="http://www.w3.org/2000/svg">
					<circle fill="currentColor" cx="6.737" cy="12.873" r="2.794"/>
					<circle fill="currentColor" cx="23.458" cy="12.873" r="2.794"/>
					<path fill="currentColor" d="M2.909,12.875l-2.918,-0c-0,-0 0.019,-8.987 -0,-11.051c-0.009,-0.892 0.363,-1.411 1.066,-1.443c2.429,-0.109 25.689,0 25.689,0c-0,0 0.491,0.11 0.875,0.878c0.445,0.89 1.724,3.349 2.213,4.228c0.161,0.289 0.175,0.995 0.175,0.995l0,6.393l-2.77,-0l-0,-0.002c-0,-2.1 -1.705,-3.804 -3.805,-3.804c-2.099,-0 -3.804,1.704 -3.804,3.804l0,0.002l-9.112,-0l-0,-0.002c-0,-2.1 -1.705,-3.804 -3.804,-3.804c-2.1,-0 -3.805,1.704 -3.805,3.804l0,0.002Zm23.608,-10.936l-3.686,-0l0,4.164l5.736,0l-2.05,-4.164Zm-19.063,-0l-6.091,-0l0,3.911l6.091,-0l-0,-3.911Zm7.156,-0l-6.091,-0l0,3.911l6.091,-0l-0,-3.911Zm7.156,-0l-6.091,-0l0,3.911l6.091,-0l-0,-3.911Z"/>
				</svg>';
	}

	/**
	 * Vlak/ŽST ikona
	 */
	private function getTrainIcon( int $size ): string {
		$width = round( $size * 1.7 );

		return '<svg width="' . $width . '" height="' . $size . '" viewBox="0 0 30 16" xmlns="http://www.w3.org/2000/svg">
					<path fill="currentColor" d="M25.162,12.904l-6.052,0c-0.071,-1.527 -1.333,-2.745 -2.878,-2.745c-1.544,-0 -2.807,1.218 -2.878,2.745l-1.574,0c-0.071,-1.527 -1.333,-2.745 -2.877,-2.745c-1.287,-0 -2.377,0.844 -2.747,2.009c-0.074,0.234 -0.247,0.736 -0.247,0.736l0,1.703l-1.18,0l-0,-0.926l-2.412,-0.001l-0.002,-10.676l-2.326,0l0,-2.252l9.417,0l-0,2.622l6.018,-0l-0,-2.549l2.237,0l-0,2.549l6.493,-0l-0,-3.444l3.051,0l0,3.444l1.012,-0l-0,0.53l0.908,0l0,5.985l-0.908,0l-0,1.563l1.794,0l-0,1.452l-3.659,0l-0,2.142l-1.19,0l-0,-2.142Zm-16.654,-9.965l-5.09,-0l0,3.074l5.09,0l-0,-3.074Z"/>
					<circle fill="currentColor" cx="8.871" cy="13.36" r="2.492"/>
					<circle fill="currentColor" cx="16.252" cy="13.36" r="2.492"/>
					<circle fill="currentColor" cx="23.207" cy="14.587" r="1.483"/>
					<circle fill="currentColor" cx="28.293" cy="14.587" r="1.483"/>
				</svg>';
	}

	/**
	 * Tramvaj ikona
	 */
	private function getTramIcon( int $size ): string {
		$width = round( $size * 1.7 );

		return '<svg width="' . $width . '" height="' . $size . '" viewBox="0 0 30 16" xmlns="http://www.w3.org/2000/svg">
					<path d="M0.801,0.083c-0.046,0.04 -0.092,0.201 -0.092,0.362c-0,0.201 1.244,0.261 6.565,0.261c3.617,0 6.565,0.081 6.565,0.181c0,0.081 -0.506,0.584 -1.151,1.107c-0.645,0.523 -1.152,1.046 -1.152,1.187c0.023,0.141 0.576,0.785 1.267,1.448c0.691,0.664 1.267,1.268 1.267,1.348c-0,0.101 -1.198,0.161 -2.649,0.161c-1.567,0 -2.65,0.081 -2.65,0.202c0,0.1 -1.313,0.221 -3.155,0.241c-3.179,0.06 -3.179,0.06 -3.249,0.543c-0.046,0.282 0.07,0.604 0.277,0.724c0.322,0.222 0.322,0.363 -0.092,1.59c-0.231,0.744 -0.507,1.972 -0.599,2.716c-0.138,1.267 -0.092,1.408 0.391,1.811c0.369,0.281 0.83,0.422 1.498,0.422c0.576,0 1.082,0.121 1.244,0.302c0.253,0.261 0.069,0.302 -1.475,0.302c-1.727,-0 -1.773,0.02 -1.704,0.442l0.069,0.463l26.031,0l0.069,-0.463c0.069,-0.422 0.023,-0.442 -1.705,-0.442c-1.635,-0 -1.774,-0.02 -1.451,-0.322c0.207,-0.161 0.806,-0.362 1.313,-0.423c0.53,-0.06 1.175,-0.302 1.428,-0.523c0.461,-0.362 0.484,-0.523 0.346,-1.69c-0.092,-0.724 -0.346,-1.931 -0.599,-2.696c-0.53,-1.71 -0.553,-1.589 0.138,-1.589c0.461,-0 0.576,-0.101 0.576,-0.503l-0,-0.503l-4.584,-0c-3.87,-0 -4.608,-0.04 -4.723,-0.302c-0.092,-0.221 -0.506,-0.302 -1.75,-0.302c-0.876,0 -1.613,-0.06 -1.613,-0.14c0,-0.081 0.622,-0.705 1.405,-1.389l1.405,-1.227l-1.405,-1.227c-0.783,-0.664 -1.405,-1.248 -1.405,-1.328c0,-0.06 3.156,-0.121 7.026,-0.121c6.059,0 7.026,-0.04 7.026,-0.302c0,-0.261 -1.843,-0.301 -14.305,-0.342c-7.856,-0.04 -14.352,-0.02 -14.398,0.021Zm7.51,14.606c0.253,0.261 0.184,0.302 -0.415,0.302c-0.553,-0 -0.691,-0.081 -0.599,-0.302c0.092,-0.161 0.277,-0.302 0.438,-0.302c0.161,0 0.415,0.141 0.576,0.302Zm11.288,-0c0.253,0.261 -0.277,0.302 -4.469,0.302c-4.331,-0 -5.045,-0.081 -4.585,-0.463c0.069,-0.081 2.097,-0.141 4.446,-0.141c3.571,0 4.377,0.06 4.608,0.302Zm3.179,0.06c0.046,0.141 -0.162,0.242 -0.53,0.242c-0.553,-0 -0.599,-0.041 -0.346,-0.302c0.323,-0.342 0.714,-0.322 0.876,0.06Zm-14.928,-7.001l0,5.432l-2.304,-0l0,-2.575c0,-1.429 0.07,-2.656 0.162,-2.716c0.069,-0.081 0.599,-0.141 1.151,-0.141l0.991,-0Zm14.052,-0l0,5.432l-1.382,-0l-0,-5.432l1.382,-0Zm2.258,2.756l0.069,2.676l-1.405,-0l-0,-5.452l0.645,0.06l0.622,0.06l0.069,2.656Zm2.027,-2.213c0.069,0.322 0.207,0.805 0.322,1.107c0.254,0.664 0.139,0.764 -0.967,0.764l-0.875,0l-0,-1.207c-0,-1.207 -0,-1.207 0.691,-1.207c0.552,-0 0.714,0.1 0.829,0.543Zm-13.776,0.604l-0.069,0.965l-1.889,0.061l-1.912,0.06l0,-2.032l3.939,0l-0.069,0.946Zm7.418,-1.147l-0,2.213l-2.073,-0l-0,-0.966c-0,-0.543 0.069,-1.046 0.161,-1.106c0.069,-0.081 0.553,-0.141 1.037,-0.141l0.875,-0Zm-2.995,0.201l0,2.012l-3.686,-0l0,-2.012l3.686,0Zm-0.76,-5.714l1.29,1.127l-1.29,1.127c-1.451,1.267 -1.359,1.287 -2.949,-0.383l-0.921,-0.965l1.175,-1.026c0.668,-0.544 1.244,-1.006 1.29,-1.006c0.069,-0 0.691,0.503 1.405,1.126Z" fill="currentColor"/>
				</svg>';
	}

	/**
	 * Lanovka ikona
	 */
	private function getLanIcon( int $size ): string {
		return '<svg width="' . $size . '" height="' . $size . '" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
					<path d="M5.015,5.556c-0.517,0.517 -0.24,1.735 0.406,1.735c0.221,0.018 0.166,0.092 -0.185,0.295c-0.59,0.314 -0.664,0.535 -0.757,2.731c-0.073,1.532 -0.055,1.68 0.351,2.086c0.369,0.369 0.609,0.424 1.827,0.424l1.384,0l0,1.329c0,1.55 0.148,1.864 0.757,1.772c0.443,-0.056 0.443,-0.074 0.443,-2.178l-0,-2.122l-2.399,-0.185l-0.093,-1.716c-0.092,-1.569 -0.129,-1.753 -0.553,-2.067c-0.369,-0.295 -0.388,-0.369 -0.148,-0.369c0.351,-0 0.701,-0.535 0.701,-1.07c0,-0.794 -1.162,-1.255 -1.734,-0.665Zm3.211,0.96c-0.369,0.295 -0.388,0.387 -0.185,0.775c0.166,0.295 0.203,0.867 0.129,1.79l-0.092,1.347l0.867,0c0.628,0 1.071,0.129 1.643,0.498l0.775,0.499l-0,1.236c-0,1.532 0.111,1.827 0.664,1.827c0.628,0 0.812,-0.517 0.812,-2.288c0,-1.883 -0.11,-2.049 -1.642,-2.215l-1.126,-0.129l0,-1.458c0,-1.236 -0.055,-1.532 -0.369,-1.845c-0.461,-0.462 -0.941,-0.462 -1.476,-0.037Zm-1.2,-5.536c-1.218,0.498 -3.026,1.217 -4.004,1.605c-1.698,0.664 -1.809,0.738 -1.809,1.218c0,0.295 0.074,0.535 0.148,0.535c0.073,0 1.273,-0.461 2.676,-1.015c1.384,-0.553 2.639,-1.015 2.768,-1.015c0.24,0 0.683,0.72 0.683,1.089c-0,0.074 -0.702,0.424 -1.569,0.757c-0.849,0.332 -1.679,0.756 -1.846,0.922c-0.258,0.296 -0.295,0.868 -0.276,3.968c-0,2.399 0.073,3.728 0.221,3.968c0.332,0.517 0.849,0.646 2.418,0.59c1.07,-0.037 1.421,-0.11 1.421,-0.313c-0,-0.203 -0.369,-0.277 -1.606,-0.314c-2.141,-0.074 -2.104,-0 -2.048,-4.152c0.037,-2.547 0.11,-3.23 0.332,-3.433c0.48,-0.443 7.898,-3.266 8.249,-3.137c0.923,0.314 0.978,0.517 0.978,3.322c0,2.509 0.018,2.639 0.369,2.639c0.351,-0 0.369,-0.13 0.369,-2.658l0,-2.657l-0.517,-0.554c-0.793,-0.849 -1.254,-0.886 -2.915,-0.24c-0.794,0.314 -1.514,0.572 -1.587,0.572c-0.148,0 -0.757,-1.107 -0.665,-1.199c0.037,-0.037 0.72,-0.332 1.532,-0.646c0.812,-0.314 1.513,-0.628 1.55,-0.664c0.037,-0.037 -0.535,-0.074 -1.292,-0.074c-1.181,0.018 -1.642,0.129 -3.58,0.886Zm4.448,4.318c-0.203,0.277 -0.222,0.48 -0.111,0.59c0.111,0.111 0.184,0.868 0.184,1.698l0,1.513l0.997,0.074c0.72,0.056 1.2,0.222 1.661,0.572c0.627,0.499 0.646,0.536 0.701,1.938c0.056,1.2 0.111,1.421 0.388,1.476c0.701,0.13 0.867,-0.276 0.867,-2.159c0,-0.978 -0.074,-1.882 -0.166,-2.03c-0.092,-0.147 -0.646,-0.277 -1.384,-0.332l-1.218,-0.111l-0,-1.624c-0,-1.421 -0.037,-1.661 -0.351,-1.827c-0.59,-0.313 -1.273,-0.221 -1.568,0.222Zm-3.138,-1.274c-0.442,0.333 -0.424,1.182 0.019,1.643c0.738,0.738 1.938,-0.185 1.55,-1.218c-0.258,-0.664 -0.978,-0.849 -1.569,-0.425Zm3.322,-1.254c-0.443,0.442 -0.369,1.328 0.129,1.642c0.905,0.609 1.864,-0.314 1.384,-1.329c-0.295,-0.59 -1.07,-0.756 -1.513,-0.313Z" fill="currentColor"/>
				</svg>';
	}

	/**
	 * Kabinová lanovka ikona
	 */
	private function getKabIcon( int $size ): string {
		return '<svg width="' . $size . '" height="' . $size . '" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
					<path d="M8.425,4.515c-0.274,0.068 -0.308,0.291 -0.308,1.694l0,1.608l-2.104,-0c-1.403,-0 -2.173,0.068 -2.31,0.205c-0.154,0.154 -0.205,1.249 -0.205,3.849c0,3.422 0.017,3.644 0.325,3.815c0.205,0.103 2.019,0.171 4.67,0.171c3.644,0 4.397,-0.034 4.722,-0.274c0.377,-0.256 0.377,-0.342 0.377,-3.815c-0,-2.531 -0.052,-3.592 -0.206,-3.746c-0.137,-0.137 -0.906,-0.205 -2.309,-0.205l-2.105,-0l0,-1.711c0,-0.941 -0.051,-1.694 -0.119,-1.694c-0.086,0.017 -0.274,0.052 -0.428,0.103Zm-1.762,4.893c0.068,0.222 0.086,0.787 0.051,1.248l-0.051,0.839l-1.232,0.051l-1.249,0.051l0,-1.18c0,-0.65 0.052,-1.232 0.12,-1.283c0.051,-0.069 0.599,-0.12 1.181,-0.12c0.992,0 1.094,0.034 1.18,0.394Zm3.131,0.923l0.051,1.249l-2.498,0l0.052,-1.283l0.068,-1.3l1.129,0.051l1.146,0.052l0.052,1.231Zm3.079,0l0.051,1.249l-2.412,0l0,-2.583l1.163,0.051l1.147,0.052l0.051,1.231Zm-4.619,-7.15c-7.527,3.028 -8.348,3.387 -8.348,3.729c-0,0.222 0.017,0.393 0.051,0.393c0.12,0 16.577,-6.637 16.663,-6.723c0.034,-0.051 0.051,-0.239 0.017,-0.41c-0.052,-0.291 -0.993,0.034 -8.383,3.011Zm-1.437,-2.07c-0.684,0.444 -0.547,1.488 0.205,1.676c0.616,0.154 0.992,-0.103 1.061,-0.736c0.085,-0.804 -0.667,-1.351 -1.266,-0.94Zm1.882,-0.582c-0.565,0.889 0.53,1.899 1.317,1.197c0.633,-0.581 0.24,-1.608 -0.616,-1.608c-0.256,0 -0.53,0.171 -0.701,0.411Z" fill="currentColor"/>
				</svg>';
	}

	/**
	 * Parkoviště ikona
	 */
	private function getParkIcon( int $size ): string {
		return '<svg width="' . $size . '" height="' . $size . '" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
					<path d="M1.591,0.219c-0.242,0.101 -0.646,0.444 -0.646,0.706c-0.109,0.629 -0.201,3.331 -0.201,7.287l-0,6.809c-0,-0 0.523,0.929 0.989,0.943c1.321,0.039 6.984,-0 6.984,-0c6.702,-0 6.984,-0.02 7.368,-0.404c0.384,-0.383 0.404,-0.666 0.404,-7.529c-0,-3.896 -0.081,-7.207 -0.162,-7.328c-0.403,-0.626 -1.09,-0.686 -7.65,-0.666c-3.634,0 -6.823,0.081 -7.086,0.182Zm9.347,2.886c2.18,1.232 2.482,4.118 0.585,5.774c-0.807,0.726 -1.797,1.029 -3.351,1.029l-1.171,0l0,3.432l-1.816,-0l-0,-10.699l2.482,0c2.181,0 2.564,0.061 3.271,0.464Zm-3.937,1.353l0,3.431l1.514,0c1.232,0 1.595,-0.08 1.918,-0.403c0.545,-0.545 0.686,-1.292 0.363,-1.938c-0.363,-0.787 -1.049,-1.09 -2.523,-1.09l-1.272,-0Z" fill="currentColor"/>
				</svg>';
	}

	/**
	 * Mapa ikon podle klíčů
	 */
	private function getIconMap(): array {
		return [
			'BUS'  => 'getBusIcon',
			'MHD'  => 'getBusIcon', // Alias pro BUS
			'ŽST'  => 'getTrainIcon',
			'ZST'  => 'getTrainIcon', // Bez diakritiky
			'TRAM' => 'getTramIcon',
			'LAN'  => 'getLanIcon',
			'KAB'  => 'getKabIcon',
			'PARK' => 'getParkIcon',
		];
	}

	/**
	 * Nahradí textové značky začínající & příslušnými ikonami
	 * Převedeno z React funkce replaceTextWithIcons()
	 *
	 * @param string $text     Vstupní text obsahující značky ve formátu &TAG nebo &TAG1,TAG2,TAG3
	 * @param int    $iconSize Velikost ikon (výchozí 10)
	 *
	 * @return string Text s nahrazenými ikonami
	 */
	public function replaceIconsInText( string $text, int $iconSize = 10, bool $hideIcon = false ): string {
		if ( empty( $text ) ) {
			return $text;
		}

		$iconMap = $this->getIconMap();

		// Najdi všechny výskyty &NĚCO nebo &NĚCO,NĚCO2,NĚCO3 (včetně diakritiky)
		return preg_replace_callback( '/&([A-ZÁĚŠČŘŽÝÚŮÍÓ.,]+)/ui', function ( $matches ) use ( $iconMap, $iconSize, $hideIcon ) {
			$iconKeys = explode( ',', $matches[1] );
			$result   = '';

			foreach ( $iconKeys as $iconKey ) {
				$iconKey = trim( $iconKey );
				// Normalizuj klíč - uppercase a odstraň interpunkci
				$normalizedKey = strtoupper( preg_replace( '/[.,]/', '', $iconKey ) );

				if ( isset( $iconMap[ $normalizedKey ] ) ) {
					if ( ! $hideIcon ) {
						$methodName = $iconMap[ $normalizedKey ];
						$result     .= '<span style="display: inline-flex; align-items: center; margin: 0 2px;">' . $this->$methodName( $iconSize ) . '</span>';
					}
					// Pokud hideIcon = true, nepřidáváme nic (ikona se odebere)
				} else {
					// Pokud ikonu nenajdeme, vrať původní text bez &
					$result .= $iconKey;
				}
			}

			return $result;
		}, $text );
	}
}