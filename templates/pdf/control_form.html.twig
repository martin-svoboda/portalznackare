{# PDF kontrolní formulář pro terénní práci #}
<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Kontrolní formulář {{ head.Cislo_ZP ?? 'Příkaz' }}</title>
    <style>
        /* Základní styling pro PDF - optimalizováno pro DomPDF */
        body {
            font-family: 'DejaVu Sans', sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
        }

        h1 {
            font-size: 14pt;
        }

        h2 {
            font-size: 12pt;
        }

        h3 {
            font-size: 10pt;
            margin-bottom: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        .lined-table th {
            background-color: #dddddd;
            padding: 1mm;
            text-align: left;
            font-weight: bold;
            border: 1px solid #000;
            font-size: 7pt;
        }

        img {
            max-width: 100%;
            margin: 0!important;
            display: block;
        }

        .lined-table > * > tr > td {
            padding: 1mm;
            border: 1px solid #000;
            vertical-align: top;
            font-size: 8pt;
        }

        .checkbox {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 1px solid #000;
            margin-right: 5px;
        }

        /* Zalamování stránek */
        .no-break {
            page-break-inside: avoid;
        }

        .page-break {
            page-break-before: always;
        }

        tfoot {
            background-color: #f5f5f5;
            font-weight: bold;
        }
    </style>
</head>
<body>
{# Header #}
<div class="header-info">
    <h1>Kontrolní formulář {{ head.Cislo_ZP ?? '' }}</h1>
    {{ head.Druh_ZP_Naz ?? '' }}
    {% if head.Popis_ZP %}
        {{ head.Popis_ZP|raw }}
    {% endif %}
    {% if head.Poznamka_ZP %}
        {{ head.Poznamka_ZP|raw }}
    {% endif %}
</div>

{# Úseky #}
{% if useky is not empty %}
    <h2>Úseky ke značení</h2>
    <table class="lined-table">
        <thead>
        <tr>
            <th style="width: 8%;">Značka</th>
            <th style="width: 40%;">Název úseku</th>
            <th style="width: 15%;">Délka</th>
            <th style="width: 37%;">Poznámka</th>
        </tr>
        </thead>
        <tbody>
        {% for usek in useky %}
            <tr>
                <td style="text-align: center;">
                    {% if usek.Znacka_HTML %}
                        {{ usek.Znacka_HTML|raw }}
                    {% else %}
                        {{ usek.Barva_Kod ?? '' }}
                    {% endif %}
                </td>
                <td>
                    <strong>{{ usek.Nazev_ZU|raw }}</strong><br>
                </td>
                <td style="text-align: right;">{{ usek.Delka_ZU|number_format(1, ',', ' ') }}</td>
                <td></td>
            </tr>
        {% endfor %}
        </tbody>
        <tfoot>
        <tr>
            <td colspan="2" style="text-align: right;"><strong>Celková délka:</strong></td>
            <td style="text-align: right;">
                <strong>{{ useky|reduce((sum, usek) => sum + usek.Delka_ZU, 0)|number_format(1, ',', ' ') }} km</strong>
            </td>
            <td></td>
        </tr>
        </tfoot>
    </table>
{% endif %}

{# TIM předměty - hlavní část formuláře #}
{% if predmety is not empty %}
    {# Seskupení předmětů podle TIM #}
    {% set timGroups = {} %}
    {% for predmet in predmety %}
        {% if predmet.EvCi_TIM %}
            {% if timGroups[predmet.EvCi_TIM] is not defined %}
                {% set timGroups = timGroups|merge({
                    (predmet.EvCi_TIM): {
                        'EvCi_TIM': predmet.EvCi_TIM,
                        'Naz_TIM': predmet.Naz_TIM,
                        'GPS_Sirka': predmet.GPS_Sirka,
                        'GPS_Delka': predmet.GPS_Delka,
                        'items': []
                    }
                }) %}
            {% endif %}
            {% set currentGroup = timGroups[predmet.EvCi_TIM] %}
            {% set currentGroup = currentGroup|merge({
                'items': currentGroup.items|merge([predmet])
            }) %}
            {% set timGroups = timGroups|merge({
                (predmet.EvCi_TIM): currentGroup
            }) %}
        {% endif %}
    {% endfor %}

    {% if timGroups is not empty %}
        <h2>Stav tabulek a směrovek (TIM)</h2>

        {% for timId, timGroup in timGroups %}
            <table class="lined-table">
                <thead>
                <tr>
                    <th colspan="8">TIM {{ timGroup.EvCi_TIM }}: {{ timGroup.Naz_TIM|raw }}</th>
                </tr>
                </thead>
                <tbody>
                {% for row in timGroup.items|batch(2) %}
                    <tr class="no-break">
                        {% for item in row %}
                            <td style="width: 27%;" rowspan="2">
                                {{ item.Tim_HTML|raw }}
                            </td>
                            <td style="width: 5%; height: 25px; color: #aaaaaa">stav</td>
                            <td style="width: 13%; height: 25px; color: #aaaaaa">rok výroby</td>
                            <td style="width: 5%; height: 25px; color: #aaaaaa">
                                {% if item.Druh_Predmetu_Naz and 'směrovka' in item.Druh_Predmetu_Naz|lower %}
                                    P/L
                                {% else %}
                                    –
                                {% endif %}
                            </td>
                        {% endfor %}
                        {% if row|length == 1 %}
                            <td rowspan="2" colspan="4"></td>
                        {% endif %}
                    </tr>
                    <tr class="no-break">
                        {% for item in row %}
                            <td style="color: #aaaaaa" colspan="3">poznámka</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                <tr>
                    <td style="width: 27%; height: 50px" colspan="8"><span style="font-size: 8pt;color: #aaaaaa">Poznámka k TIM:</span></td>
                </tr>
                </tfoot>
            </table>
            </div>
        {% endfor %}
    {% endif %}
{% else %}
    <div style="margin-top: 20px; padding: 15px; background-color: #eff6ff; border-left: 4px solid #3b82f6;">
        <p style="margin: 0; color: #1e40af;">
            Pro tento příkaz nejsou k dispozici žádné TIM k hodnocení.
        </p>
    </div>
{% endif %}

{# Footer #}
<div class="footer">
    <p>
        Portál značkaře - Kontrolní formulář<br>
        Vygenerováno: {{ generated_at|date('d.m.Y H:i') }}
    </p>
</div>

</body>
</html>
