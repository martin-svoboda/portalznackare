name: Deploy Portal Znaƒçka≈ôe

on:
  push:
    branches:
      - main
    tags:
      - '*'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    env:
      SSH_SERVER: 37.235.105.56
      SSH_USER: root
      SSH_PORT: 22
      DEV_PATH: /www/hosting/portalznackare.cz/dev/
      PROD_PATH: /www/hosting/portalznackare.cz/www/
      IS_TAG: ${{ startsWith(github.ref, 'refs/tags/') }}
      IS_MAIN: ${{ github.ref == 'refs/heads/main' }}
      APP_VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: ctype, iconv, json, pdo, pdo_pgsql, pdo_sqlsrv
          coverage: none
          tools: composer:v2

      - name: Set up Composer cache
        uses: actions/cache@v3
        with:
          path: /tmp/composer-cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies (DEV)
        if: env.IS_MAIN == 'true'
        run: |
          composer install --optimize-autoloader --no-scripts --no-interaction
          composer dump-autoload --optimize

      - name: Install Composer dependencies (PROD)
        if: env.IS_TAG == 'true'
        run: |
          composer install --no-dev --optimize-autoloader --no-scripts --no-interaction
          composer dump-autoload --optimize --no-dev

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Build frontend assets
        run: |
          npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa -p $SSH_PORT $SSH_SERVER >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o BatchMode=yes $SSH_USER@$SSH_SERVER "echo 'SSH connection successful'"

      - name: Deploy to DEV (main branch)
        if: env.IS_MAIN == 'true'
        run: |
          # Sync soubory (bez vendor a node_modules - ty se nainstaluj√≠ na serveru)
          rsync -av --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            --exclude=".git" \
            --exclude=".gitignore" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude="var" \
            --exclude=".env.local*" \
            --exclude="README.md" \
            --exclude="Claude.md" \
            --exclude="*.md" \
            --exclude="vendor" \
            --exclude="public/uploads" \
            . $SSH_USER@$SSH_SERVER:$DEV_PATH

          # Remote commands na DEV serveru
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_SERVER << 'EOF'
          set -euxo pipefail
          cd ${{ env.DEV_PATH }}
          
          # Nastav spr√°vn√° opr√°vnƒõn√≠
          chown -R www-data:www-data .
          find . -type d -exec chmod 755 {} \;
          find . -type f -exec chmod 644 {} \;
          chmod +x bin/console
          
          # Check if composer exists and install if needed
          if ! command -v composer &> /dev/null; then
            echo "Installing Composer..."
            curl -sS https://getcomposer.org/installer | php
            mv composer.phar /usr/local/bin/composer
            chmod +x /usr/local/bin/composer
          fi
          
          # Debug PHP a extensions na serveru
          echo "=== PHP Debug Info ==="
          /usr/bin/php8.3 -v
          echo "=== SQLSRV Extensions Check ==="
          /usr/bin/php8.3 -m | grep -E "(pdo_sqlsrv|sqlsrv)" || echo "No SQLSRV found"
          echo "=== Test MSSQL connection ==="
          /usr/bin/php8.3 -r "echo class_exists('PDO') ? 'PDO: OK' : 'PDO: Missing'; echo PHP_EOL;"
          /usr/bin/php8.3 -r "echo in_array('sqlsrv', PDO::getAvailableDrivers()) ? 'SQLSRV Driver: OK' : 'SQLSRV Driver: Missing'; echo PHP_EOL;" || echo "PDO SQLSRV test failed"
          
          # Set Composer environment variables
          export COMPOSER_ALLOW_SUPERUSER=1
          export COMPOSER_NO_INTERACTION=1
          
          # Composer install na serveru bez spou≈°tƒõn√≠ auto-scripts
          composer install --optimize-autoloader --no-scripts --no-interaction
          
          # Zkontroluj ≈æe existuje .env.local s DB √∫daji
          if [ ! -f .env.local ]; then
            echo "‚ùå Missing .env.local file with database credentials!"
            echo "Please create .env.local on server with:"
            echo "# Internal PostgreSQL database for portal content"
            echo "DATABASE_URL=postgresql://portal_user:password@localhost:5432/portal_db"
            echo "# External MSSQL INSYZ connection"
            echo "USE_TEST_DATA=false"
            echo "INSYZ_DB_HOST=insyz_server"
            echo "INSYZ_DB_NAME=insyz_database"
            echo "INSYZ_DB_USER=insyz_user"
            echo "INSYZ_DB_PASS=insyz_password"
            echo "APP_SECRET=your-secret-here"
            exit 1
          fi
          
          # Symfony commands ruƒçnƒõ s PHP 8.3 (jako web server)
          if /usr/bin/php8.3 bin/console --version > /dev/null 2>&1; then
            echo "‚úÖ Symfony console working with PHP 8.3"
            /usr/bin/php8.3 bin/console cache:clear --env=dev || echo "‚ö†Ô∏è Cache clear failed"
            /usr/bin/php8.3 bin/console doctrine:migrations:status --env=dev || echo "‚ö†Ô∏è Migration status check failed"
            /usr/bin/php8.3 bin/console doctrine:migrations:migrate --no-interaction --env=dev || echo "‚ö†Ô∏è Migration skipped (no migrations or DB issue)"
            
            # Cache pools setup
            echo "üöÄ Setting up cache pools..."
            /usr/bin/php8.3 bin/console cache:pool:clear app.api_cache --env=dev 2>/dev/null || echo "‚ö†Ô∏è API cache pool not available"
            /usr/bin/php8.3 bin/console cache:pool:list --env=dev 2>/dev/null || echo "‚ö†Ô∏è Cache pool list unavailable"
          else
            echo "‚ö†Ô∏è Symfony console not working with PHP 8.3, skipping Symfony commands"
          fi
          
          # Nastav writable adres√°≈ôe
          chmod -R 777 var/cache var/log public/build 2>/dev/null || true
          
          # Setup/restart Messenger Worker
          echo "‚öôÔ∏è Configuring Messenger Worker..."
          if [ -f deploy/setup-messenger.sh ]; then
            chmod +x deploy/setup-messenger.sh
            if ! systemctl is-enabled --quiet portal-messenger 2>/dev/null; then
              echo "üîß Setting up Messenger Worker for first time..."
              ./deploy/setup-messenger.sh || echo "‚ö†Ô∏è Messenger setup failed, continuing..."
            else
              echo "üîÑ Restarting existing Messenger Worker..."
              systemctl restart portal-messenger || echo "‚ö†Ô∏è Messenger restart failed"
              sleep 2
              systemctl is-active --quiet portal-messenger && echo "‚úÖ Messenger Worker running" || echo "‚ùå Messenger Worker failed"
            fi
          fi
          
          echo "‚úÖ DEV deployment completed"
          EOF

      - name: Deploy to PROD (tagged release)
        if: env.IS_TAG == 'true'
        run: |
          # Backup produkce p≈ôed deployment
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_SERVER << 'EOF'
          if [ -d ${{ env.PROD_PATH }} ]; then
            mkdir -p /backup
            cp -r ${{ env.PROD_PATH }} /backup/portal-znackare-$(date +%Y%m%d-%H%M%S)
            echo "‚úÖ Production backup created"
          fi
          EOF

          # Sync soubory na produkci
          rsync -av --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            --exclude=".git" \
            --exclude=".gitignore" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude="var/cache" \
            --exclude="var/log" \
            --exclude="var/testdata.json" \
            --exclude="var/debug-*.txt" \
            --exclude=".env.local*" \
            --exclude="README.md" \
            --exclude="Claude.md" \
            --exclude="*.md" \
            --exclude="vendor" \
            --exclude="public/uploads" \
            --exclude="var/sessions" \
            . $SSH_USER@$SSH_SERVER:$PROD_PATH

          # Remote commands na PROD serveru
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_SERVER << 'EOF'
          set -euxo pipefail
          cd ${{ env.PROD_PATH }}
          
          # Nastav spr√°vn√° opr√°vnƒõn√≠
          chown -R www-data:www-data .
          find . -type d -exec chmod 755 {} \;
          find . -type f -exec chmod 644 {} \;
          chmod +x bin/console
          
          # Check if composer exists and install if needed
          if ! command -v composer &> /dev/null; then
            echo "Installing Composer..."
            curl -sS https://getcomposer.org/installer | php
            mv composer.phar /usr/local/bin/composer
            chmod +x /usr/local/bin/composer
          fi
          
          # Set Composer environment variables
          export COMPOSER_ALLOW_SUPERUSER=1
          export COMPOSER_NO_INTERACTION=1
          
          # Composer install na serveru (PROD - bez dev dependencies a bez auto-scripts)
          composer install --no-dev --optimize-autoloader --no-scripts --no-interaction
          
          # Zkontroluj ≈æe existuje .env.local s DB √∫daji
          if [ ! -f .env.local ]; then
            echo "‚ùå Missing .env.local file with database credentials!"
            echo "Please create .env.local on server with:"
            echo "APP_ENV=prod"
            echo "# Internal PostgreSQL database for portal content"
            echo "DATABASE_URL=postgresql://portal_user:password@localhost:5432/portal_db"
            echo "# External MSSQL INSYZ connection"
            echo "USE_TEST_DATA=false"
            echo "INSYZ_DB_HOST=insyz_server"
            echo "INSYZ_DB_NAME=insyz_database"
            echo "INSYZ_DB_USER=insyz_user"
            echo "INSYZ_DB_PASS=insyz_password"
            echo "APP_SECRET=your-production-secret"
            exit 1
          fi
          
          # Symfony commands ruƒçnƒõ s PHP 8.3
          if /usr/bin/php8.3 bin/console --version > /dev/null 2>&1; then
            echo "‚úÖ Symfony console working with PHP 8.3"
            /usr/bin/php8.3 bin/console cache:clear --env=prod || echo "‚ö†Ô∏è Cache clear failed"
            /usr/bin/php8.3 bin/console doctrine:migrations:status --env=prod || echo "‚ö†Ô∏è Migration status check failed"
            /usr/bin/php8.3 bin/console doctrine:migrations:migrate --no-interaction --env=prod || echo "‚ö†Ô∏è Migration skipped (no migrations or DB issue)"
            
            # Production cache warming
            echo "üöÄ Production cache warming..."
            /usr/bin/php8.3 bin/console cache:warmup --env=prod 2>/dev/null || echo "‚ö†Ô∏è Cache warmup failed"
            
            # Verify cache pools are available
            /usr/bin/php8.3 bin/console cache:pool:list --env=prod 2>/dev/null | grep "app.api_cache" && echo "‚úÖ API cache pool ready" || echo "‚ö†Ô∏è API cache pool not available"
          else
            echo "‚ö†Ô∏è Symfony console not working with PHP 8.3, skipping Symfony commands"
          fi
          
          # Nastav writable adres√°≈ôe
          chmod -R 777 var/cache var/log public/build 2>/dev/null || true
          
          # Setup/restart Messenger Worker
          echo "‚öôÔ∏è Configuring Messenger Worker..."
          if [ -f deploy/setup-messenger.sh ]; then
            chmod +x deploy/setup-messenger.sh
            if ! systemctl is-enabled --quiet portal-messenger 2>/dev/null; then
              echo "üîß Setting up Messenger Worker for first time..."
              ./deploy/setup-messenger.sh || echo "‚ö†Ô∏è Messenger setup failed, continuing..."
            else
              echo "üîÑ Restarting existing Messenger Worker..."
              systemctl restart portal-messenger || echo "‚ö†Ô∏è Messenger restart failed"
              sleep 2
              systemctl is-active --quiet portal-messenger && echo "‚úÖ Messenger Worker running" || echo "‚ùå Messenger Worker failed"
            fi
          fi
          
          # Restart PHP-FPM 8.3 (pro portalznackare.cz)
          systemctl reload php8.3-fpm 2>/dev/null || true
          
          echo "‚úÖ PROD deployment completed"
          EOF

      - name: Health check DEV
        if: env.IS_MAIN == 'true'
        run: |
          sleep 10
          echo "Testing basic index.php..."
          INDEX_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dev.portalznackare.cz/ || echo "000")
          echo "Index page returned HTTP $INDEX_CODE"
          
          echo "Testing INSYZ PDO connection..."
          MSSQL_RESPONSE=$(curl -s https://dev.portalznackare.cz/api/test/mssql-connection || echo "curl_failed")
          MSSQL_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dev.portalznackare.cz/api/test/mssql-connection || echo "000")
          echo "INSYZ connection test returned HTTP $MSSQL_CODE"
          echo "Response: $MSSQL_RESPONSE"
          
          # Test API monitoring logs
          echo "Testing API monitoring logs..."
          API_LOG_RESPONSE=$(curl -s -o /dev/null -w "%{time_total}" https://dev.portalznackare.cz/api/test/insyz-user || echo "0")
          echo "API response time: ${API_LOG_RESPONSE}s"
          
          if [ "$MSSQL_CODE" != "200" ]; then
            echo "‚ö†Ô∏è INSYZ connection test failed, but continuing deployment"
            
            # Show recent error logs for debugging
            echo "=== Recent error logs ==="
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_SERVER "tail -20 ${{ env.DEV_PATH }}var/log/dev.log || echo 'No dev.log found'"
          else
            echo "‚úÖ INSYZ connection test passed"
          fi

      - name: Health check PROD
        if: env.IS_TAG == 'true'
        run: |
          sleep 10
          echo "Testing INSYZ PDO connection..."
          MSSQL_RESPONSE=$(curl -s https://portalznackare.cz/api/test/mssql-connection || echo "curl_failed")
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://portalznackare.cz/api/test/mssql-connection || echo "000")
          echo "INSYZ connection test returned HTTP $HTTP_CODE"
          echo "Response: $MSSQL_RESPONSE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ö†Ô∏è PROD INSYZ connection test failed, but continuing deployment"
            # Zobraz error log pro debugging
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_SERVER "tail -20 ${{ env.PROD_PATH }}var/log/prod.log || echo 'No prod.log found'"
          else
            echo "‚úÖ PROD INSYZ connection test passed"
          fi

      - name: Create GitHub Release (only for tag)
        if: env.IS_TAG == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Portal Znaƒçka≈ôe ${{ github.ref_name }}"
          body: |
            ## üöÄ Nov√° verze Portal Znaƒçka≈ôe
            
            **Verze:** ${{ github.ref_name }}
            **Datum:** ${{ github.event.head_commit.timestamp }}
            
            ### Zmƒõny v t√©to verzi
            ${{ github.event.head_commit.message }}
            
            ### Deployment
            - ‚úÖ Nasazeno na produkci: https://portalznackare.cz
            - ‚úÖ API endpointy ovƒõ≈ôeny
            - ‚úÖ Health check pro≈°el
            
            ### API Endpoints
            - `GET /api/test/insyz-user` - Test u≈æivatelsk√Ωch dat
            - `GET /api/test/insyz-prikazy` - Test p≈ô√≠kaz≈Ø

          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa